#!/bin/bash
set -euo pipefail

if [ -n "$(git status --porcelain)" ]; then
  echo "Error: working directory is not clean. Commit or stash changes before building." >&2
  exit 1
fi

echo "Building Fusion AI..."

BUILD_DIR=$(mktemp -d)
trap 'rm -rf "$BUILD_DIR"' EXIT

# Compose HTML pages into build dir (dashboard + standalone)
npx tsx web-app/app/compose.ts "$BUILD_DIR"

# Bundle TypeScript into build dir
mkdir -p "$BUILD_DIR/assets"
npx esbuild web-app/app/core.ts \
  --bundle \
  --minify \
  --keep-names \
  --target=es2024 \
  --format=iife \
  --outfile="$BUILD_DIR/assets/app.js"

echo "Bundle created: assets/app.js ($(wc -c < "$BUILD_DIR/assets/app.js" | xargs) bytes)"

# Bundle and minify CSS â€” concatenate in cascade order, minify via esbuild
cat web-app/app/styles/fonts.css \
    web-app/app/styles/tokens.css \
    web-app/app/styles/dark-mode.css \
    web-app/app/styles/base.css \
    web-app/app/styles/components.css \
    web-app/app/styles/layout.css \
    web-app/app/styles/utilities.css \
    web-app/app/styles/responsive.css \
    web-app/app/styles/pages.css \
    web-app/app/styles/command-palette.css \
  | npx esbuild --loader=css --minify > "$BUILD_DIR/assets/styles.css"

echo "Styles created: assets/styles.css ($(wc -c < "$BUILD_DIR/assets/styles.css" | xargs) bytes)"
cp web-app/assets/*.woff2 "$BUILD_DIR/assets/"
cp web-app/index.html "$BUILD_DIR/"
cp web-app/assets/favicon.ico "$BUILD_DIR/assets/"

# Create distribution ZIP on Desktop
SHA=$(git rev-parse --short=7 HEAD)
ZIPNAME="fusion-ai-${SHA}.zip"

ZIPDEST="$HOME/Desktop/$ZIPNAME"

(cd "$BUILD_DIR" && zip -r "$ZIPDEST" .)

echo "Distribution: $ZIPDEST ($(wc -c < "$ZIPDEST" | xargs) bytes)"
echo "Done."
