#!/bin/bash
set -euo pipefail

if [ -n "$(git status --porcelain)" ]; then
  echo "Error: working directory is not clean. Commit or stash changes before building." >&2
  exit 1
fi

echo "Building Fusion AI..."

# Compose HTML pages: combine layout.html with per-page page.html
npx tsx site/compose.ts

# Bundle TypeScript into a single JS file
npx esbuild site/script.ts \
  --bundle \
  --minify \
  --target=es2020 \
  --format=iife \
  --outfile=site/app.js

echo "Bundle created: site/app.js ($(wc -c < site/app.js | tr -d ' ') bytes)"

# Create distribution ZIP
SHA=$(git rev-parse --short=7 HEAD)
ZIPNAME="fusion-ai-${SHA}.zip"

zip -r "$ZIPNAME" \
  index.html \
  */index.html \
  site/style.css \
  site/app.js \
  fonts/ \
  -x "*.ts" "*.map" "node_modules/*"

echo "Distribution: $ZIPNAME ($(wc -c < "$ZIPNAME" | tr -d ' ') bytes)"
echo "Done."
